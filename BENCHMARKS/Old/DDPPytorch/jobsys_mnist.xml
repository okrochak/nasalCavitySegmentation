<?xml version="1.0" encoding="UTF-8"?>
<!-- author: EI -->
<!-- version: 210629a -->

<jube>
  <benchmark name="bench_mnist" outpath="bench_run">
    <comment>Benchmark of DDP using MNIST</comment>
    
    <!-- benchmark -->
    <!-- iterNO - iterated nodes -->
    <!-- iterBS - iterated batch_size -->
    <!-- iterEP - iterated epochs -->
    <!-- iterCM - iterated condM -->
    <!-- bench configuration -->
    <parameterset name="param_set">
      <parameter name="iterNO" type="int">2,4,8,16,32</parameter>
      <parameter name="iterBS" type="int">10,100</parameter>
      <parameter name="iterEP" type="int">10</parameter>
      <parameter name="iterCM" type="int">100</parameter>
      <parameter name="iterNW" type="int">8</parameter>
      <parameter name="iterPF" type="int">2</parameter>
    </parameterset>

    <!-- job configuration -->
    <parameterset name="executeset">
      <parameter name="submit_cmd">sbatch</parameter>
      <parameter name="nodes">$iterNO</parameter>
      <parameter name="nbs">$iterBS</parameter>
      <parameter name="nes">$iterEP</parameter>
      <parameter name="ncm">$iterCM</parameter>
      <parameter name="nnw">$iterNW</parameter>
      <parameter name="npf">$iterPF</parameter>
      <parameter name="ready_file">ready</parameter>
      <parameter name="job_file">benchScript_mnist</parameter>
      <parameter name="script">DDP_pytorch_mnist.py</parameter>
    </parameterset>

    <!-- load jobfile -->
    <fileset name="files">
      <copy>$job_file</copy>
      <link>$script</link>
    </fileset>

    <!-- substitute jobfile -->
    <substituteset name="sub_job">
      <iofile in="${job_file}" out="$job_file" />
      <sub source="#NODES#" dest="$nodes" />
      <sub source="#BS#" dest="$nbs" />
      <sub source="#EPCS#" dest="$nes" />
      <sub source="#CMS#" dest="$ncm" />
      <sub source="#READY#" dest="$ready_file" />
      <sub source="#NW#" dest="$nnw" />
      <sub source="#PF#" dest="$npf" />
    </substituteset> 

    <!-- operation/execution of bench -->
    <step name="submit" work_dir="JUBE/${jube_benchmark_id}_${jube_wp_id}" >
      <use>param_set</use>
      <use>executeset</use>
      <use>files,sub_job</use>
      <do>echo "nID: $jube_wp_id"</do> <!-- shell command -->

      <do done_file="$ready_file">$submit_cmd $job_file</do> <!-- shell command -->
    </step>

    <!-- results -->
    <!-- regex pattern -->
    <patternset name="pattern">
      <pattern name="ID" unit="" type="int">\s*nID:\s+$jube_pat_wrd\s*</pattern>
      <pattern name="Nnodes" unit="" type="int">\s*DEBUG: SLURM_NNODES:\s+$jube_pat_wrd\s*</pattern>
      <pattern name="Nworkers" unit="" type="int">\s*DEBUG: args.nworker:\s+$jube_pat_wrd\s*</pattern>
      <pattern name="prefetchF" unit="" type="int">\s*DEBUG: args.prefetch:\s+$jube_pat_wrd\s*</pattern>
      <pattern name="batchSize" unit="" type="int">\s*DEBUG: args.batch_size:\s+$jube_pat_wrd\s*</pattern>
      <pattern name="Nepochs" unit="" type="int">\s*DEBUG: args.epochs:\s+$jube_pat_wrd\s*</pattern>
      <pattern name="dataSize" unit="" type="int">\s*DEBUG: args.concM:\s+$jube_pat_wrd\s*</pattern>
      <pattern name="calcTime" unit="s" type="float">\s*TIMER: total epoch time:\s+$jube_pat_wrd\s*</pattern>
      <pattern name="memoryGPU" unit="MB" type="int">\s*DEBUG: memory req:\s+$jube_pat_wrd\s*</pattern>
      <pattern name="accuracy" unit="%" type="float">\s*DEBUG: last accuracy:\s+$jube_pat_wrd\s*</pattern>
    </patternset>

    <!-- analyse -->
    <analyzer name="analyse" >
      <use>pattern</use> <!-- use existing patternset -->
      <analyse step="submit">
        <file>stdout</file>
        <file>job.out</file>
      </analyse>
    </analyzer>

    <!-- create result table -->
    <result>
      <use>analyse</use>
      <table name="result" style="pretty" sort="jube_wp_id">
        <column>ID</column>
        <column>Nnodes</column>
        <column>Nworkers</column>
        <column>prefetchF</column>
        <column>batchSize</column>
        <column>Nepochs</column>
        <column>dataSize</column>
        <column>calcTime</column>
        <column>memoryGPU</column>
        <column>accuracy</column>
      </table>
    </result>
    
  </benchmark>
</jube>

<!-- eof -->
